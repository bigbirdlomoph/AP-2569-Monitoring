<script>
  var CACHED_OPTIONS = null;

  $(document).ready(function() {
    loadDashboardData();
    // Initialize Select2
    $('#txOrder').select2({ theme: 'bootstrap-5', placeholder: '-- เลือกลำดับ --', allowClear: true });
    
    $('#txOrder').on('select2:select', function (e) { onTxOrderChange(); });
    $('#txOrder').on('select2:clear', function (e) { 
        $('#txActivity').empty().append('<option value="">-- เลือกกิจกรรม --</option>').prop('disabled', true);
        $('#divTxSubActivity').addClass('d-none');
        $('#txInfoBox').addClass('d-none');
    });

    google.script.run.withSuccessHandler(function(data) { 
      CACHED_OPTIONS = data;
      populateDeptDropdowns('#searchDeptSelect');
      populateDeptDropdowns('#yearlyDeptSelect');
      populateOrderDropdown('#txOrder');
      populateDeptDropdowns('#loanDept'); 
    }).getAllMasterDataForClient();
  });

  // (Helper function getTimelineDisplayHtml omitted - same as before)
  function getTimelineDisplayHtml(timeline) {
      var months = ['ต.ค.', 'พ.ย.', 'ธ.ค.', 'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.'];
      var activeCount = timeline.filter(x => x).length;
      if (activeCount === 0) return '-';
      if (activeCount === 12) return '<span class="badge bg-success rounded-pill fw-normal">ทั้งปีงบประมาณ</span>';
      var html = '<div class="d-flex flex-wrap gap-1 justify-content-center">';
      var quarters = [
          { name: 'ไตรมาส 1', indices: [0, 1, 2] }, { name: 'ไตรมาส 2', indices: [3, 4, 5] },
          { name: 'ไตรมาส 3', indices: [6, 7, 8] }, { name: 'ไตรมาส 4', indices: [9, 10, 11] }
      ];
      quarters.forEach(function(q) {
          var activeInQ = q.indices.filter(idx => timeline[idx]);
          if (activeInQ.length === 3) { html += `<span class="badge bg-primary rounded-pill fw-normal">${q.name}</span>`; } 
          else if (activeInQ.length > 0) { activeInQ.forEach(idx => html += `<span class="badge bg-success fw-normal">${months[idx]}</span>`); }
      });
      html += '</div>';
      return html;
  }

  // (Dropdown populators omitted - same as before)
  function populateDeptDropdowns(selector) {
    if (!CACHED_OPTIONS) return;
    var depts = [...new Set(CACHED_OPTIONS.map(r => r.dept).filter(Boolean))].sort();
    var select = $(selector);
    select.empty().append('<option value="">-- เลือกกลุ่มงาน --</option>');
    if(selector === '#searchDeptSelect' || selector === '#yearlyDeptSelect') {
        select.find('option').first().text('-- แสดงทั้งหมด --');
    }
    depts.forEach(d => select.append(`<option value="${d}">${d}</option>`));
  }

  function populateOrderDropdown(selector) {
    if (!CACHED_OPTIONS) return;
    var orders = [...new Set(CACHED_OPTIONS.map(r => r.order).filter(o => o != "" && o != null))].sort((a,b) => a - b);
    var select = $(selector);
    select.empty().append('<option value="">-- เลือกลำดับ --</option>');
    orders.forEach(o => select.append(`<option value="${o}">${o}</option>`));
  }

  function switchPage(pageId, element) {
    $('.page-section').addClass('d-none');
    $('#' + pageId + '-page').removeClass('d-none');
    $('.nav-pill-btn').removeClass('active');
    
    if (pageId === 'transaction') {
        document.getElementById('txDate').valueAsDate = new Date();
        loadTxHistory();
    }
    if (pageId === 'loan') {
        document.getElementById('loanDate').valueAsDate = new Date();
        loadLoanHistory();
        loadLoanSummary();
    }
    if (pageId === 'yearly' && $('#yearlyDeptSelect option').length <= 1) initYearlyPage();
  }

  // (Dashboard Functions omitted - same as before)
  function loadDashboardData() { google.script.run.withSuccessHandler(renderDashboard).getDashboardData(); }
  function renderDashboard(data) {
    if(data.error) { console.error("Dashboard Error:", data.error); return; }
    updateCards('moph', data.moph); renderGauge('mophGauge', data.moph); renderBarChart('mophBar', data.moph.deptStats, '#198754'); 
    updateCards('nonmoph', data.nonMoph); renderGauge('nonMophGauge', data.nonMoph); renderBarChart('nonMophBar', data.nonMoph.deptStats, '#0d6efd'); 
  }
  function updateCards(prefix, stats) {
    var fmt = (num) => Number(num).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    $('#' + prefix + '-approved').text(fmt(stats.approved));
    $('#' + prefix + '-allocated').text(fmt(stats.allocated));
    $('#' + prefix + '-spent').text(fmt(stats.spent));
    $('#' + prefix + '-balance').text(fmt(stats.balance));
  }
  function renderGauge(canvasId, stats) {
    var alloc = stats.allocated || 0;
    var spent = stats.spent || 0;
    var percent = alloc > 0 ? (spent / alloc) * 100 : 0;
    $('#' + canvasId + 'Text').text(percent.toFixed(2) + '%');
    var chartStatus = Chart.getChart(canvasId); if (chartStatus) chartStatus.destroy();
    new Chart(document.getElementById(canvasId), {
      type: 'doughnut',
      data: { labels: ['เบิกจ่าย', 'คงเหลือ'], datasets: [{ data: [percent, 100 - percent], backgroundColor: ['#dc3545', '#e9ecef'], borderWidth: 0, hoverOffset: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, rotation: -90, circumference: 180, cutout: '80%', plugins: { legend: {display:false}, tooltip: {enabled:false} } }
    });
  }
  function renderBarChart(canvasId, deptStats, colorTheme) {
    var chartData = [];
    for (var dept in deptStats) {
       var alloc = deptStats[dept].allocated;
       var spent = deptStats[dept].spent;
       var pct = alloc > 0 ? (spent / alloc) * 100 : 0;
       if(alloc > 0) chartData.push({ label: dept, y: pct });
    }
    chartData.sort((a, b) => b.y - a.y);
    var chartStatus = Chart.getChart(canvasId); if (chartStatus) chartStatus.destroy();
    new Chart(document.getElementById(canvasId), {
      type: 'bar',
      data: { labels: chartData.map(d => d.label), datasets: [{ data: chartData.map(d => d.y), backgroundColor: colorTheme, borderRadius: 4, barPercentage: 0.6 }] },
      options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', plugins: { legend: {display:false}, tooltip: { callbacks: { label: (c) => c.raw.toFixed(2) + '%' } } }, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (v) => v + "%" } }, x: { grid: {display:false} } } }
    });
  }

  // (Search & Yearly functions unchanged)
  function initSearchPage() { if (CACHED_OPTIONS) { populateDeptDropdowns('#searchDeptSelect'); } }
  function runSearch() {
    var dept = $('#searchDeptSelect').val();
    $('#searchTableBody').html('<tr><td colspan="8" class="text-center py-4 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>กำลังค้นหาข้อมูล...</td></tr>');
    google.script.run.withSuccessHandler(renderSearchPage).searchActionPlan(dept);
  }
  function resetSearch() {
    $('#searchDeptSelect').val('');
    $('#sum-count').text('0'); $('#sum-approved').text('0.00'); $('#sum-allocated').text('0.00');
    if ($.fn.DataTable.isDataTable('#searchTable')) { $('#searchTable').DataTable().destroy(); }
    $('#searchTableBody').empty().html('<tr><td colspan="8" class="text-center py-5 text-muted"><i class="fas fa-search fa-2x mb-2 opacity-50"></i><br>กรุณาเลือกกลุ่มงานและกดค้นหา</td></tr>');
  }
  function renderSearchPage(data) {
    if(data.error) { $('#searchTableBody').html('<tr><td colspan="8" class="text-center text-danger">Error: '+ data.error +'</td></tr>'); return; }
    var fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    $('#sum-count').text(Number(data.summary.count).toLocaleString());
    $('#sum-approved').text(fmt(data.summary.approved));
    $('#sum-allocated').text(fmt(data.summary.allocated));
    if ($.fn.DataTable.isDataTable('#searchTable')) { $('#searchTable').DataTable().destroy(); }
    var tbody = $('#searchTableBody'); tbody.empty();
    if (data.list.length === 0) { tbody.html('<tr><td colspan="8" class="text-center py-4 text-muted">ไม่พบข้อมูล</td></tr>'); return; }
    data.list.forEach(function(row) {
      var timelineHtml = getTimelineDisplayHtml(row.timeline);
      tbody.append(`<tr><td class="ps-3">${row.order}</td><td><span class="badge bg-light text-dark border">${row.dept}</span></td><td><div class="fw-bold text-wrap">${row.project}</div><div class="small text-muted">${row.activity}</div></td><td><span class="badge bg-secondary fw-normal">${row.budgetType}</span></td><td><span class="badge bg-info text-dark fw-normal">${row.budgetSource}</span></td><td class="text-center text-nowrap">${timelineHtml}</td><td class="text-end text-primary">${fmt(row.approved)}</td><td class="text-end fw-bold text-success">${fmt(row.allocated)}</td></tr>`);
    });
    $('#searchTable').DataTable({ "language": { "search": "ค้นหา:", "paginate": { "next": ">", "previous": "<" } }, "pageLength": 10, "order": [[ 0, "asc" ]] });
  }

  function initYearlyPage() { if (CACHED_OPTIONS) { populateDeptDropdowns('#yearlyDeptSelect'); } }
  function loadYearlyData() {
    var dept = $('#yearlyDeptSelect').val();
    $('#yearlyTableBody').html('<tr><td colspan="9" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>กำลังประมวลผลข้อมูล...</td></tr>');
    google.script.run.withSuccessHandler(renderYearlyPage).getYearlyPlanData(dept);
  }
  function resetYearly() {
    $('#yearlyDeptSelect').val('');
    $('#yp-count').text('0'); $('#yp-alloc').text('0.00'); $('#yp-spent').text('0.00');
    if ($.fn.DataTable.isDataTable('#yearlyTable')) { $('#yearlyTable').DataTable().destroy(); }
    $('#yearlyTableBody').empty().html('<tr><td colspan="9" class="text-center py-5 text-muted"><i class="fas fa-filter fa-2x mb-2 opacity-50"></i><br>กรุณาเลือกกลุ่มงานเพื่อดูข้อมูล</td></tr>');
  }
  function renderYearlyPage(data) {
    if(data.error) { $('#yearlyTableBody').html('<tr><td colspan="9" class="text-center text-danger">'+data.error+'</td></tr>'); return; }
    var fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    $('#yp-count').text(Number(data.summary.projects).toLocaleString());
    $('#yp-alloc').text(fmt(data.summary.allocated));
    $('#yp-spent').text(fmt(data.summary.spent));
    if ($.fn.DataTable.isDataTable('#yearlyTable')) { $('#yearlyTable').DataTable().destroy(); }
    var tbody = $('#yearlyTableBody'); tbody.empty();
    if (data.list.length === 0) { tbody.html('<tr><td colspan="9" class="text-center py-4 text-muted">ไม่พบข้อมูล</td></tr>'); return; }
    data.list.forEach(row => {
        var timelineHtml = getTimelineDisplayHtml(row.timeline);
        tbody.append(`<tr><td class="ps-3">${row.order}</td><td><span class="badge bg-light text-dark border">${row.dept}</span></td><td><div class="fw-bold text-wrap" style="font-size: 1rem;">${row.project}</div><div class="small text-muted mt-1"><i class="fas fa-tasks me-1"></i>${row.activity}</div></td><td><span class="badge bg-secondary fw-normal">${row.type}</span></td><td><span class="badge bg-info text-dark fw-normal">${row.budgetSource}</span></td><td class="text-center text-nowrap">${timelineHtml}</td><td class="text-end">${fmt(row.allocated)}</td><td class="text-end">${fmt(row.spent)}</td><td class="text-end pe-3 fw-bold ${row.balance < 0 ? 'text-danger':'text-success'}">${fmt(row.balance)}</td></tr>`);
    });
    $('#yearlyTable').DataTable({ "language": { "search": "ค้นหา:", "paginate": { "next": ">", "previous": "<" } }, "pageLength": 10, "order": [[ 0, "asc" ]] });
  }

  // --- EXPENSE TRANSACTION (Unchanged) ---
  function onTxOrderChange() {
    var order = $('#txOrder').val();
    var select = $('#txActivity').empty().append('<option value="">-- เลือกกิจกรรม --</option>').prop('disabled', true);
    $('#divTxSubActivity').addClass('d-none');
    $('#txSubActivity').empty();
    $('#txInfoBox').addClass('d-none');
    if(!order) return;
    var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order));
    if (rows.length > 0) {
       $('#tx_disp_proj').text(rows[0].project);
       $('#tx_disp_dept').text(rows[0].dept);
       $('#txProjectInfo').removeClass('d-none');
       var activities = [...new Set(rows.map(r => r.activity))].sort();
       activities.forEach(act => { select.append(`<option value="${act}">${act}</option>`); });
       select.prop('disabled', false);
    }
  }
  function onTxActivityChange() {
    var order = $('#txOrder').val();
    var actName = $('#txActivity').val();
    var subSelect = $('#txSubActivity').empty().append('<option value="">-- เลือกกิจกรรมย่อย --</option>');
    $('#divTxSubActivity').addClass('d-none');
    $('#txInfoBox').addClass('d-none');
    if (!actName) return;
    var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order) && r.activity === actName);
    var subActivities = rows.filter(r => r.subActivity && r.subActivity !== "").map(r => r.subActivity);
    if (subActivities.length > 0) {
        subActivities.forEach(sub => {
            var row = rows.find(r => r.subActivity === sub);
            subSelect.append(`<option value="${sub}" data-id="${row.id}" data-alloc="${row.allocated}" data-bal="${row.balance}" data-proj="${row.project}" data-dept="${row.dept}" data-order="${row.order}">${sub}</option>`);
        });
        $('#divTxSubActivity').removeClass('d-none');
    } else {
        var row = rows[0];
        if (row) { updateTxInfoBox(row.allocated, row.balance, row.id, row.project, row.dept, row.order); }
    }
  }
  function showTxBudgetInfo() {
     var opt = $('#txSubActivity option:selected');
     if (opt.val()) { updateTxInfoBox(opt.data('alloc'), opt.data('bal'), opt.data('id'), opt.data('proj'), opt.data('dept'), opt.data('order')); } 
     else { $('#txInfoBox').addClass('d-none'); }
  }
  function updateTxInfoBox(alloc, bal, id, proj, dept, order) {
     $('#tx_alloc').text(Number(alloc).toLocaleString());
     $('#tx_bal').text(Number(bal).toLocaleString());
     $('#txInfoBox').attr('data-id', id).removeClass('d-none');
  }
  function submitTransaction() {
    var amount = parseFloat($('#txAmount').val());
    var type = $('#txExpenseType').val();
    if (!type) { Swal.fire('แจ้งเตือน', 'กรุณาเลือกประเภทค่าใช้จ่าย', 'warning'); return; }
    if (amount <= 0) { Swal.fire('แจ้งเตือน', 'กรุณาระบุยอดเงิน', 'warning'); return; }
    var projectId = $('#txInfoBox').attr('data-id');
    if (!projectId) { Swal.fire('แจ้งเตือน', 'กรุณาเลือกกิจกรรมให้ครบถ้วน', 'warning'); return; }
    var formData = { projectId: projectId, dept: $('#tx_disp_dept').text(), project: $('#tx_disp_proj').text(), activity: $('#txActivity').val(), txDate: $('#txDate').val(), amount: amount, expenseType: type, desc: $('#txDesc').val() };
    $('#btnSaveTx').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>กำลังบันทึก...');
    google.script.run.withSuccessHandler(function(res) {
      $('#btnSaveTx').prop('disabled', false).html('<i class="fas fa-save me-2"></i>บันทึกและตัดยอด');
      if (res.status === 'success') {
        Swal.fire('สำเร็จ', res.message, 'success');
        $('#txForm')[0].reset(); $('#txOrder').val(null).trigger('change'); document.getElementById('txDate').valueAsDate = new Date(); loadTxHistory();
      } else { Swal.fire('Error', res.message, 'error'); }
    }).saveTransaction(formData);
  }
  function loadTxHistory() {
    google.script.run.withSuccessHandler(function(rows) {
      var tbody = $('#txHistoryTable'); tbody.empty();
      if (rows.length === 0) { tbody.append('<tr><td colspan="6" class="text-center text-muted py-3">ยังไม่มีรายการเบิกจ่าย</td></tr>'); return; }
      rows.forEach(r => {
        var activityHtml = `<div class="fw-bold">${r.activity}</div>`;
        if (r.subActivity) { activityHtml += `<div class="text-muted small">${r.subActivity}</div>`; }
        var amt = Number(r.amount).toLocaleString();
        tbody.append(`<tr><td><div class="text-wrap" style="max-width: 150px;">${r.project}</div></td><td>${activityHtml}</td><td class="text-nowrap">${r.date}</td><td><span class="badge bg-secondary text-light">${r.type}</span></td><td><div class="text-wrap" style="max-width: 150px;">${r.desc}</div></td><td class="text-end pe-3 fw-bold text-danger">-${amt}</td></tr>`);
      });
    }).getTransactionHistory();
  }

  // --- LOAN TRANSACTION (Color Updates Here) ---
  function onLoanDeptChange() {
    var dept = $('#loanDept').val();
    var select = $('#loanProject').empty().append('<option value="">-- เลือกโครงการ --</option>').prop('disabled', true);
    $('#loanActivity').empty().append('<option value="">-- เลือกกิจกรรม --</option>').prop('disabled', true);
    $('#loanInfoBox').addClass('d-none');
    if(!dept) return;
    var projects = [...new Set(CACHED_OPTIONS.filter(r => r.dept === dept).map(r => r.project))].sort();
    projects.forEach(p => select.append(`<option value="${p}">${p}</option>`));
    select.prop('disabled', false);
  }
  function onLoanProjectChange() {
    var dept = $('#loanDept').val();
    var proj = $('#loanProject').val();
    var select = $('#loanActivity').empty().append('<option value="">-- เลือกกิจกรรม --</option>').prop('disabled', true);
    $('#loanInfoBox').addClass('d-none');
    if(!proj) return;
    var activities = CACHED_OPTIONS.filter(r => r.dept === dept && r.project === proj);
    activities.forEach(item => {
       var subAct = item.subActivity ? ` (${item.subActivity})` : '';
       select.append(`<option value="${item.activity}" data-id="${item.id}" data-alloc="${item.allocated}" data-loan="${item.loan}" data-type="${item.budgetType}" data-source="${item.budgetSource}" data-codeb="${item.budgetCode}" data-codea="${item.activityCode}" data-actname="${item.activity}" data-subact="${item.subActivity}">${item.activity}${subAct}</option>`);
    });
    select.prop('disabled', false);
  }
  function showLoanBudgetInfo() {
    var opt = $('#loanActivity option:selected');
    if (opt.data('id')) {
      $('#l_type').text(opt.data('type'));
      $('#l_source').text(opt.data('source'));
      $('#l_code_b').text(opt.data('codeb') || '-');
      $('#l_code_a').text(opt.data('codea') || '-');
      $('#l_alloc').text(Number(opt.data('alloc')).toLocaleString());
      $('#l_loaned').text(Number(opt.data('loan')).toLocaleString());
      $('#loanInfoBox').removeClass('d-none');
    } else { $('#loanInfoBox').addClass('d-none'); }
  }
  function submitLoan() {
    var amount = parseFloat($('#loanAmount').val());
    var type = $('#loanType').val();
    if (!type) { Swal.fire('แจ้งเตือน', 'กรุณาเลือกประเภทเงินยืม', 'warning'); return; }
    if (amount <= 0) { Swal.fire('แจ้งเตือน', 'กรุณาระบุยอดเงิน', 'warning'); return; }
    var projectId = $('#loanActivity option:selected').data('id');
    var formData = { projectId: projectId, amount: amount, loanDate: $('#loanDate').val(), loanType: type, desc: $('#loanDesc').val() };
    $('#btnSaveLoan').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>กำลังบันทึก...');
    google.script.run.withSuccessHandler(function(res) {
      $('#btnSaveLoan').prop('disabled', false).html('<i class="fas fa-save me-2"></i>บันทึกรายการ');
      if (res.status === 'success') {
        Swal.fire('สำเร็จ', res.message, 'success');
        $('#loanForm')[0].reset(); 
        $('#loanProject').prop('disabled', true); $('#loanActivity').prop('disabled', true); $('#loanInfoBox').addClass('d-none');
        document.getElementById('loanDate').valueAsDate = new Date();
        loadLoanHistory();
        loadLoanSummary();
      } else { Swal.fire('Error', res.message, 'error'); }
    }).saveLoan(formData);
  }
  function loadLoanHistory() {
    google.script.run.withSuccessHandler(function(rows) {
      var tbody = $('#loanHistoryTable'); tbody.empty();
      if (rows.length === 0) { tbody.append('<tr><td colspan="6" class="text-center text-muted py-3">ยังไม่มีรายการยืม</td></tr>'); return; }
      rows.forEach(r => {
        var activityHtml = `<div class="fw-bold">${r.activity}</div>`;
        if (r.subActivity) { activityHtml += `<div class="text-muted small">${r.subActivity}</div>`; }
        var amt = Number(r.amount).toLocaleString();
        // UPDATED: text-primary
        tbody.append(`<tr><td><div class="text-wrap" style="max-width: 150px;">${r.project}</div></td><td>${activityHtml}</td><td class="text-nowrap">${r.date}</td><td><span class="badge bg-info text-dark">${r.type}</span></td><td><div class="text-wrap" style="max-width: 150px;">${r.details}</div></td><td class="text-end pe-3 fw-bold text-primary">${amt}</td></tr>`);
      });
    }).getLoanHistory();
  }
  function loadLoanSummary() {
    google.script.run.withSuccessHandler(function(rows) {
        var tbody = $('#loanSummaryTable'); tbody.empty();
        if (rows.length === 0) { tbody.append('<tr><td colspan="2" class="text-center text-muted">ไม่มีข้อมูล</td></tr>'); return; }
        rows.forEach(r => {
            // UPDATED: text-primary
            tbody.append(`<tr><td class="ps-3"><div class="text-truncate" style="max-width: 250px;" title="${r.project}">${r.project}</div></td><td class="text-end pe-3 fw-bold text-primary">${Number(r.total).toLocaleString()}</td></tr>`);
        });
    }).getLoanSummaryByProject();
  }
</script>
