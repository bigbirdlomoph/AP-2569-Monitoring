<script>
  // ==========================================
  // 1. GLOBAL VARIABLES & NAVIGATION
  // ==========================================
  var CACHED_OPTIONS = null;
  var summaryPieChart = null; 
  var summaryBarChart = null; 
  var CURRENT_DD_DATA = null;
  var LOAN_DATA_CACHE = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô

  function switchPage(pageId, element) {
    $('.page-section').addClass('d-none');
    $('#' + pageId + '-page').removeClass('d-none');
    $('.nav-pill-btn').removeClass('active');
    if(element) $(element).addClass('active');
    
    // Trigger Page Logic
    if (pageId === 'transaction') { loadTxHistory(); } //‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢
    if (pageId === 'loan') { document.getElementById('loanDate').valueAsDate = new Date(); loadLoanHistory(); } //‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô
    if (pageId === 'yearly') initYearlyPage(); //‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ
    if (pageId === 'summary') { loadSummary(); } //Executive Summary
    if (pageId === 'dashboard') { loadDashboardData(); } //‡∏´‡∏ô‡πâ‡∏≤ Dashboard
    if (pageId === 'allocation') { initAllocPage(); } //‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
  }

  // ==========================================
  // 2. INITIALIZATION (SAFETY FIRST METHOD)
  // ==========================================
  $(document).ready(function() {
    console.log("System Initializing...");

    // A. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
    refreshMasterData();
    loadDashboardData();

    // B. SETUP SELECT2 : GROUP 1 (Transaction Modal)
    $('#txOrder').select2({ 
        theme: 'bootstrap-5', placeholder: '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö --', allowClear: true,
        dropdownParent: $('#txModal') 
    });
    $('#txActivity').select2({ 
        theme: 'bootstrap-5', placeholder: '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --', allowClear: true,
        dropdownParent: $('#txModal') 
    });
    var wrapTemplateTx = {
        theme: 'bootstrap-5', placeholder: '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢ --', allowClear: true,
        dropdownParent: $('#txModal'),
        templateResult: formatState, templateSelection: formatState
    };
    $('#txSubActivity').select2(wrapTemplateTx);

    // C. SETUP SELECT2 : GROUP 2 (Loan Modal)
    $('#loanOrder').select2({ 
      theme: 'bootstrap-5', placeholder: '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö --', allowClear: true,
      dropdownParent: $('#loanModal') 
    });
    $('#loanActivity').select2({ 
        theme: 'bootstrap-5', placeholder: '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --', allowClear: true,
        dropdownParent: $('#loanModal') 
    });
    var wrapTemplateLoan = {
        theme: 'bootstrap-5', placeholder: '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢ --', allowClear: true,
        dropdownParent: $('#loanModal'),
        templateResult: formatState, templateSelection: formatState
    };
    $('#loanSubActivity').select2(wrapTemplateLoan);

    // D. SETUP SELECT2 : GROUP 3 (Search Filters)
    // ------------------------------------------------
    var searchIds = ['#searchTxOrder', '#searchLoanAct', '#searchTxAct', '#searchTxProj', '#searchDeptSelect', '#yearlyDeptSelect', '#searchLoanSub', '#searchTxSub'];
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Template ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡πÜ ‡∏•‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)
    var searchTemplate = {
        theme: 'bootstrap-5', 
        placeholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 
        allowClear: true,
        templateResult: formatState,     // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥
        templateSelection: formatState   // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏î‡πâ‡∏ß‡∏¢
    };
    
    // Apply ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    searchIds.forEach(function(id) {
        $(id).select2(searchTemplate);
    });

    // Apply ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Loan (Search Filters)
    $('#searchLoanOrder').select2($.extend({}, searchTemplate, { placeholder: 'üîç ‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏≥‡∏î‡∏±‡∏ö...' }));
    $('#searchLoanProj').select2($.extend({}, searchTemplate, { placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...' }));

    // E. EVENT LISTENERS
    // Transaction Events
    $('#txOrder').on('change select2:select', function (e) { onTxOrderChange(); });
    $('#txOrder').on('select2:clear', function (e) { clearTxForm(); });
    $('#txActivity').on('change select2:select', function(e) { onTxActivityChange(); });

    // Loan Events
    $('#loanOrder').on('select2:select', function (e) { onLoanOrderChange(); });
    $('#loanOrder').on('select2:clear', function (e) { clearLoanForm(); });
    $('#loanActivity').off('select2:select').on('select2:select', function(e) { onLoanActivityChange(); });

    // Cascading Search Events
    $('#searchLoanOrder').on('select2:select', function(e) { onCascadingChange('searchLoan', 'order'); });
    $('#searchLoanProj').on('select2:select', function(e) { onCascadingChange('searchLoan', 'proj'); });
    $('#searchLoanAct').on('select2:select', function(e) { onCascadingChange('searchLoan', 'act'); });
    $('#searchTxOrder').on('select2:select', function(e) { onCascadingChange('searchTx', 'order'); });
    $('#searchTxProj').on('select2:select', function(e) { onCascadingChange('searchTx', 'proj'); });
    $('#searchTxAct').on('select2:select', function(e) { onCascadingChange('searchTx', 'act'); });

    // Back to Top
    let mybutton = document.getElementById("btn-back-to-top");
    if(mybutton){
        window.onscroll = function () { if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) { mybutton.style.display = "block"; } else { mybutton.style.display = "none"; } };
        mybutton.addEventListener("click", function() { window.scrollTo({top: 0, behavior: 'smooth'}); });
    }
  });

  // Helper for Select2 Template
  function formatState (data) {
      if (!data.id) { return data.text; }
      return $('<div style="white-space: normal; word-wrap: break-word; line-height: 1.5; padding: 3px 0;">' + data.text + '</div>');
  }

  // ==========================================
  // 3. MASTER DATA LOADER
  // ==========================================
  function refreshMasterData() {
      google.script.run.withSuccessHandler(function(data) { 
          CACHED_OPTIONS = data || [];
          populateInitDropdowns();
      }).getAllMasterDataForClient();
  }

  function populateInitDropdowns() {
      if (!CACHED_OPTIONS) return;
      var orders = [...new Set(CACHED_OPTIONS.map(r => r.order).filter(o => o != "" && o != null))].sort((a,b) => a - b);
      ['#txOrder', '#loanOrder', '#searchLoanOrder', '#searchTxOrder'].forEach(sel => {
          var $s = $(sel); $s.empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö --</option>');
          orders.forEach(o => $s.append(`<option value="${o}">${o}</option>`));
      });
      var depts = [...new Set(CACHED_OPTIONS.map(r => r.dept).filter(Boolean))].sort();
      ['#searchDeptSelect', '#yearlyDeptSelect'].forEach(sel => {
          var $s = $(sel); $s.empty().append('<option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>');
          depts.forEach(d => $s.append(`<option value="${d}">${d}</option>`));
      });
  }

  // ==========================================
  // 4. DASHBOARD LOGIC
  // ==========================================
  function loadDashboardData() { 
      $('#moph-approved').html('<i class="fas fa-spinner fa-spin"></i>');
      google.script.run.withSuccessHandler(renderDashboard).getDashboardData(); 
  }

  function renderDashboard(data) { 
      if(!data || data.error) { 
          $('#moph-approved').html('<span class="text-danger small">' + (data ? data.error : "Error") + '</span>'); 
          return; 
      } 
      updateCards('moph', data.moph); 
      renderGauge('mophGauge', data.moph); 
      renderBarChart('mophBar', data.moph.deptStats, '#198754'); 
      updateCards('nonmoph', data.nonMoph); 
      renderGauge('nonMophGauge', data.nonMoph); 
      renderBarChart('nonMophBar', data.nonMoph.deptStats, '#0d6efd'); 
  }

  function updateCards(prefix, stats) { 
      var fmt = (num) => Number(num).toLocaleString(undefined, {minimumFractionDigits: 2}); 
      $('#' + prefix + '-approved').text(fmt(stats.approved)); 
      $('#' + prefix + '-allocated').text(fmt(stats.allocated)); 
      $('#' + prefix + '-spent').text(fmt(stats.spent)); 
      $('#' + prefix + '-balance').text(fmt(stats.balance)); 
  }

  function renderGauge(canvasId, stats) { 
      var alloc = stats.allocated || 0; var spent = stats.spent || 0; 
      var percent = alloc > 0 ? (spent / alloc) * 100 : 0; 
      $('#' + canvasId + 'Text').text(percent.toFixed(2) + '%'); 
      var ctx = document.getElementById(canvasId);
      if(ctx) {
          var chartStatus = Chart.getChart(canvasId); 
          if (chartStatus != undefined) { chartStatus.destroy(); }
          new Chart(ctx, { 
              type: 'doughnut', 
              data: { labels: ['‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'], datasets: [{ data: [percent, 100 - percent], backgroundColor: ['#dc3545', '#e9ecef'], borderWidth: 0, hoverOffset: 0 }] }, 
              options: { responsive: true, maintainAspectRatio: false, rotation: -90, circumference: 180, cutout: '80%', plugins: { legend: {display:false}, tooltip: {enabled:false} } } 
          });
      }
  }

  function renderBarChart(canvasId, deptStats, colorTheme) { 
      var chartData = []; 
      for (var dept in deptStats) { 
          var alloc = deptStats[dept].allocated; var spent = deptStats[dept].spent; 
          var pct = alloc > 0 ? (spent / alloc) * 100 : 0; 
          if(alloc > 0) chartData.push({ label: dept, y: pct }); 
      } 
      chartData.sort((a, b) => b.y - a.y); 
      var ctx = document.getElementById(canvasId);
      if(ctx) {
          var chartStatus = Chart.getChart(canvasId); 
          if (chartStatus != undefined) { chartStatus.destroy(); }
          new Chart(ctx, { 
              type: 'bar', 
              data: { labels: chartData.map(d => d.label), datasets: [{ data: chartData.map(d => d.y), backgroundColor: colorTheme, borderRadius: 4, barPercentage: 0.6 }] }, 
              options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', plugins: { legend: {display:false}, tooltip: { callbacks: { label: (c) => c.raw.toFixed(2) + '%' } } }, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (v) => v + "%" } }, x: { grid: {display:false} } } } 
          }); 
      }
  }

  // ==========================================
  // 5. TRANSACTION LOGIC
  // ==========================================
  function onTxOrderChange() { 
      var order = $('#txOrder').val(); 
      var select = $('#txActivity').empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>'); 
      $('#divTxSubActivity').addClass('d-none'); 
      $('#txSubActivity').empty(); 
      $('#txInfoBox').addClass('d-none'); 
      
      if(!order) { 
          select.trigger('change').prop('disabled', true); 
          return; 
      } 
      
      var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order)); 
      if (rows.length > 0) { 
          $('#tx_disp_proj').text(rows[0].project).removeClass('text-truncate').addClass('text-wrap').css('font-size', '0.9rem'); 
          $('#tx_disp_dept').text(rows[0].dept); 
          $('#txProjectInfo').removeClass('d-none');
          var activities = [...new Set(rows.map(r => r.activity))].sort(); 
          activities.forEach(act => { select.append(`<option value="${act}">${act}</option>`); }); 
          select.trigger('change').prop('disabled', false); 
      } 
  }

  function onTxActivityChange() { 
      var order = $('#txOrder').val(); 
      var actName = $('#txActivity').val(); 
      var subSelect = $('#txSubActivity').empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢ --</option>'); 
      $('#divTxSubActivity').addClass('d-none'); 
      $('#txInfoBox').addClass('d-none'); 
      
      if (!actName) return; 
      var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order) && r.activity === actName); 
      var subActivities = rows.filter(r => r.subActivity).map(r => r.subActivity); 
      
      if (subActivities.length > 0) { 
          subActivities.forEach(sub => { 
              var row = rows.find(r => r.subActivity === sub); 
              subSelect.append(`<option value="${sub}" data-id="${row.id}" data-alloc="${row.allocated}" data-bal="${row.balance}" data-proj="${row.project}" data-dept="${row.dept}" data-order="${row.order}">${sub}</option>`); 
          }); 
          $('#divTxSubActivity').removeClass('d-none'); 
      } else { 
          var row = rows[0]; if (row) updateTxInfoBox(row.allocated, row.balance, row.id); 
      } 
  }

  function showTxBudgetInfo() { 
      var opt = $('#txSubActivity option:selected'); 
      if (opt.val()) updateTxInfoBox(opt.data('alloc'), opt.data('bal'), opt.data('id')); 
  }

  function updateTxInfoBox(alloc, bal, id) { 
      $('#tx_alloc').text(Number(alloc).toLocaleString()); 
      var pct = (alloc > 0) ? (bal / alloc * 100) : 0;
      var colorClass = (pct < 20) ? 'text-danger' : (pct < 50 ? 'text-success' : 'text-primary');
      $('#tx_bal').text(Number(bal).toLocaleString()).removeClass('text-primary text-danger text-success text-warning').addClass(colorClass); 
      $('#txInfoBox').attr('data-id', id).removeClass('d-none'); 
  }

  function clearTxForm() { 
      $('#txActivity').empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>').trigger('change').prop('disabled', true); 
      $('#divTxSubActivity').addClass('d-none'); 
      $('#txInfoBox').addClass('d-none'); 
      $('#txProjectInfo').addClass('d-none');
  }

  function openTxModal() {
      $('#txForm')[0].reset();
      clearTxForm(); 
      $('#txOrder').val(null).trigger('change'); 
      document.getElementById('txDate').valueAsDate = new Date(); 
      new bootstrap.Modal(document.getElementById('txModal')).show();
  }

  function loadTxHistory() { 
      $('#txHistoryTable').html('<tr><td colspan="6" class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-success"></i><div class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></td></tr>'); 
      google.script.run.withSuccessHandler(renderTxTable).getTransactionHistory(); 
  }

  function renderTxTable(rows) {
      // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ DataTables ‡πÄ‡∏î‡∏¥‡∏°
      if ($.fn.DataTable.isDataTable('#tableTxHistoryNew')) { 
          $('#tableTxHistoryNew').DataTable().destroy(); 
      }

      var tbody = $('#txHistoryTable'); 
      tbody.empty();

      // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      if (!rows || rows.length === 0) {
          tbody.append('<tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢</td></tr>');
          return;
      }

      // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß
      rows.forEach(r => {
          // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Badge ‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô
          var sourceBadge = (r.source && (r.source.includes('Non') || r.source.includes('‡∏ô‡∏≠‡∏Å'))) 
              ? '<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 ms-1">Non-MOPH</span>' 
              : '<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 ms-1">MOPH</span>';
          
          // ‚úÖ [‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á split ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥
          // (‡∏Ñ‡πà‡∏≤ r.date ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Server ‡πÄ‡∏õ‡πá‡∏ô "8 ‡∏Å.‡∏û. 2569" ‡πÅ‡∏•‡πâ‡∏ß)
          var dateShow = `<div class="fw-bold text-primary" style="font-size: 1rem;">${r.date}</div>`;
          
          var amountShow = Number(Math.abs(r.amount)).toLocaleString();

          tbody.append(`
              <tr>
                  <td class="ps-4 text-center text-muted fw-bold">${r.order}</td>
                  <td class="text-center">${dateShow}</td> <td>
                      <div class="fw-bold text-dark text-wrap" style="line-height: 1.4;">${r.project}</div>
                      <div class="small text-muted text-wrap mt-1">${r.activity}</div>
                  </td>
                  <td>
                      <div class="text-wrap text-muted small" style="line-height: 1.4;">${r.desc || '-'}</div>
                      <div class="mt-1">
                          <span class="badge bg-secondary fw-normal">${r.type}</span> ${sourceBadge}
                      </div>
                  </td>
                  <td class="text-end pe-4">
                      <span class="h6 fw-bold text-dark mb-0">${amountShow}</span>
                  </td>
                  <td class="text-center">
                      <div class="d-flex justify-content-center gap-1">
                          <button class="btn btn-sm btn-light text-warning hover-warning" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" onclick="confirmTxAction('edit', '${r.order}')">
                              <i class="fas fa-pen"></i>
                          </button>
                          <button class="btn btn-sm btn-light text-danger hover-danger" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" onclick="confirmTxAction('delete', '${r.order}')">
                              <i class="fas fa-trash-alt"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `);
      });

      // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á DataTable ‡πÉ‡∏´‡∏°‡πà
      $('#tableTxHistoryNew').DataTable({ 
          "pageLength": 10, 
          "lengthChange": false, 
          "searching": true, 
          "language": { 
              "search": "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", 
              "paginate": { "next": ">", "previous": "<" }, 
              "emptyTable": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
              "info": "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
          }, 
          "order": [] // ‡∏õ‡∏¥‡∏î Auto Sort ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Server
      });
  }

  function confirmTxAction(action, id) {
      if (action === 'delete') {
          Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${id} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }).then((res) => { if (res.isConfirmed) Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); });
      } else if (action === 'edit') {
          Swal.fire({ title: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?', text: `‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${id}`, icon: 'question', showCancelButton: true, confirmButtonColor: '#ffc107', confirmButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }).then((res) => { if (res.isConfirmed) Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'info'); });
      }
  }

  function submitTransaction() { 
      var amount = parseFloat($('#txAmount').val()); 
      if(!amount) { Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô','warning'); return; }
      var projectId = $('#txInfoBox').attr('data-id'); 
      if(!projectId) { Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£','warning'); return; }

      var formData = { 
          projectId: projectId, dept: $('#tx_disp_dept').text(), project: $('#tx_disp_proj').text(), 
          activity: $('#txActivity').val(), txDate: $('#txDate').val(), amount: amount, 
          expenseType: $('#txExpenseType').val(), desc: $('#txDesc').val() 
      }; 

      $('#btnSaveTx').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'); 
      google.script.run.withSuccessHandler(function(res) { 
          $('#btnSaveTx').prop('disabled', false).html('<i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); 
          if (res.status === 'success') { 
              bootstrap.Modal.getInstance(document.getElementById('txModal')).hide();
              Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
              refreshMasterData(); loadTxHistory(); 
          } 
      }).saveTransaction(formData); 
  }

  // ==========================================
  // 6. LOAN FUNCTIONS (Clean & Complete)
  // ==========================================
  function openLoanModal() {
    $('#loanForm')[0].reset();
    clearLoanForm();
    $('#loanOrder').val(null).trigger('change');
    document.getElementById('loanDate').valueAsDate = new Date();
    new bootstrap.Modal(document.getElementById('loanModal')).show();
  }

  function clearLoanForm() {
    $('#loanActivity').empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>').trigger('change').prop('disabled', true);
    $('#divLoanSubActivity').addClass('d-none');
    $('#loanInfoBox').addClass('d-none');
    $('#loanStartDate').val('');
    $('#loanEndDate').val('');
  }

  // üõ†Ô∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô onLoanOrderChange : ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô
  function onLoanOrderChange() {
      var order = $('#loanOrder').val();
      var select = $('#loanActivity').empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>');
      
      // Reset ‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ
      $('#divLoanSubActivity').addClass('d-none');
      $('#loanSubActivity').empty();
      $('#loanInfoBox').addClass('d-none');

      if (!order) {
          select.trigger('change').prop('disabled', true);
          return;
      }

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å CACHED_OPTIONS
      var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order));
      
      if (rows.length > 0) {
          // 1. ‡πÅ‡∏™‡∏î‡∏á Info Box ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          updateLoanInfoBox(rows[0]);
          
          // 2. ‡∏î‡∏∂‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Activities) ‡∏°‡∏≤‡πÉ‡∏™‡πà Dropdown
          var activities = [...new Set(rows.map(r => r.activity).filter(a => a))].sort();
          activities.forEach(act => { 
              // ‡πÉ‡∏ä‡πâ new Option ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©
              select.append(new Option(act, act)); 
          });
          
          // 3. ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Dropdown
          select.trigger('change').prop('disabled', false);
      }
  }

  function onLoanActivityChange() {
    var order = $('#loanOrder').val();
    var actName = $('#loanActivity').val();
    var subSelect = $('#loanSubActivity').empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢ --</option>');
    $('#divLoanSubActivity').addClass('d-none');
    
    if (!actName) return;
    
    var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order) && r.activity === actName);
    var subActivities = rows.filter(r => r.subActivity).map(r => r.subActivity);
    
    if (subActivities.length > 0) {
        subActivities.forEach(sub => {
            var row = rows.find(r => r.subActivity === sub);
            var option = new Option(sub, sub);
            $(option).data('row', row);
            subSelect.append(option);
        });
        $('#divLoanSubActivity').removeClass('d-none');
    } else {
        if(rows[0]) updateLoanInfoBox(rows[0]);
    }
  }

  function showLoanBudgetInfoFromSub() {
    var opt = $('#loanSubActivity option:selected');
    var rowData = $(opt).data('row');
    if (rowData) updateLoanInfoBox(rowData);
  }

  function updateLoanInfoBox(row) {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Modal
    $('#loan_disp_proj').text(row.project);
    $('#loan_disp_dept').text(row.dept);
    $('#l_bal').text(Number(row.balance).toLocaleString());
    $('#l_loaned').text(Number(row.loan).toLocaleString());
    $('#l_alloc').text(Number(row.allocated).toLocaleString());
    
    // ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô Save
    $('#loanInfoBox').attr('data-id', row.id).removeClass('d-none');
  }

  function submitLoan() {
    var amount = parseFloat($('#loanAmount').val());
    if (!amount) { Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'warning'); return; }
    
    var projectId = $('#loanInfoBox').attr('data-id');
    if (!projectId) { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', 'error'); return; }

    var formData = {
        projectId: projectId,
        amount: amount,
        loanDate: $('#loanDate').val(),
        startDate: $('#loanStartDate').val(),
        endDate: $('#loanEndDate').val(),
        loanType: $('#loanType').val(),
        desc: $('#loanDesc').val()
    };

    $('#btnSaveLoan').prop('disabled', true).text('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
    
    google.script.run.withSuccessHandler(function(res) {
        $('#btnSaveLoan').prop('disabled', false).text('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        if (res.status === 'success') {
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            var modalEl = document.getElementById('loanModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            refreshMasterData();
            loadLoanHistory();
        } else {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error');
        }
    }).saveLoan(formData);
  }

  function loadLoanHistory() {
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    $('#loanHistoryTable').html('<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>');
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Server
    google.script.run.withSuccessHandler(function(rows) {
        LOAN_DATA_CACHE = rows || []; // üíæ ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Cache
        renderLoanTable(LOAN_DATA_CACHE); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
    }).getLoanHistory();
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô
  function renderLoanTable(rows) {
        if ($.fn.DataTable.isDataTable('#tableLoanHistory')) { 
            $('#tableLoanHistory').DataTable().destroy(); 
        }
        
        var tbody = $('#loanHistoryTable');
        tbody.empty();

        if (rows && rows.length > 0) {
            rows.sort(function(a, b) {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
                // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏¢‡∏≤‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Server ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏∂‡∏á
                return 0; 
            });

            rows.forEach(r => {
                var activityHtml = `<div class="fw-bold text-dark text-wrap" style="font-size: 0.95rem;">${r.project}</div>`;
                if (r.activity) activityHtml += `<div class="small text-muted text-wrap mt-1"><i class="fas fa-tasks me-1 opacity-50"></i>${r.activity}</div>`;
                
                var amt = Number(r.amount).toLocaleString();
                var paidAmt = Number(r.paid).toLocaleString(); // ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏∑‡∏ô
                
                // Badge ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                var statusBadge = '';
                if (r.balance <= 0) statusBadge = '<span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3">‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>';
                else if (r.paid > 0) statusBadge = '<span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded-pill px-3">‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô</span>';
                else statusBadge = '<span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</span>';

                // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                var btnHtml = '';
                if (r.balance <= 0) {
                    btnHtml = `<button class="btn btn-sm text-secondary w-100" style="background-color: #f8f9fa; border: 1px dashed #dee2e6;" disabled><i class="fas fa-check-circle me-1 text-success"></i>‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏£‡∏ö</button>`;
                } else {
                    btnHtml = `<button class="btn btn-sm btn-outline-primary w-100 shadow-sm hover-scale" onclick="openRepaymentModal('${r.timestamp}', '${r.project}', ${r.amount}, ${r.balance})"><i class="fas fa-hand-holding-usd me-1"></i>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>`;
                }

                // ‚úÖ LOGIC ‡∏™‡∏µ Badge ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏ö (‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡∏≠‡∏Å = ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
                var budgetTypeClass = 'bg-light text-dark border'; // ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏ó‡∏≤)
                if (String(r.budgetType).includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡∏≠‡∏Å')) {
                    budgetTypeClass = 'bg-success-subtle text-success border border-success-subtle'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                }

                var budgetInfo = `<span class="badge ${budgetTypeClass} fw-normal mb-1">${r.budgetType || '-'}</span>
                                  <div class="small text-dark fw-bold text-wrap" style="font-size: 0.8rem;">${r.budgetSource || ''}</div>`; // ‚úÖ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏á‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Ç‡πâ‡∏°

                tbody.append(`
                    <tr>
                        <td class="text-center fw-bold text-secondary small">${r.order}</td>
                        <td>${activityHtml}</td>
                        <td>
                            <div class="fw-bold text-dark text-nowrap">${r.date}</div>
                            <div class="mt-1">${statusBadge}</div>
                        </td>
                        <td class="text-end fw-bold text-primary">${amt}</td>
                        
                        <td class="text-end text-success">${paidAmt}</td>
                        
                        <td>${budgetInfo}</td>
                        <td><div class="text-wrap small text-muted" style="max-width: 150px;">${r.desc || '-'}</div></td>
                        <td class="text-center align-middle">${btnHtml}</td>
                    </tr>
                `);
            });
        }

        $('#tableLoanHistory').DataTable({
            "pageLength": 10, "lengthChange": true, "searching": false, "ordering": false, 
            "language": {
                "paginate": { "next": ">", "previous": "<" },
                "emptyTable": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô",
                "info": "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
            }
        });
    }
  // ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô

  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Server ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏î‡∏¥‡∏°
  function refreshLoanTableData() {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Google Sheet
      google.script.run.withSuccessHandler(function(rows) {
          LOAN_DATA_CACHE = rows || []; // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Cache
          runLoanSearch(); // 2. ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà user ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
      }).getLoanHistory();
  }

  function resetLoanSearch() {
    // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á
    $('#searchLoanOrder').val(null).trigger('change');
    // Cascading ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏•‡∏π‡∏Å (Proj, Act, Sub) ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ trigger change ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏°‡πà
    // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏î‡πâ‡∏ß‡∏¢
    $('#searchLoanProj').val(null).trigger('change').prop('disabled', true);
    $('#searchLoanAct').val(null).trigger('change').prop('disabled', true);
    $('#searchLoanSub').val(null).trigger('change').prop('disabled', true);

    // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Cache ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡∏°‡πà
    renderLoanTable(LOAN_DATA_CACHE);
  }

  function runLoanSearch() {
    // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
    var sOrder = $('#searchLoanOrder').val();
    var sProj = $('#searchLoanProj').val();
    var sAct = $('#searchLoanAct').val();
    var sSub = $('#searchLoanSub').val();

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cache (Client-side Filtering)
    var filteredRows = LOAN_DATA_CACHE.filter(r => {
        var match = true;
        // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤ (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô String ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå)
        if (sOrder && String(r.order) !== String(sOrder)) match = false;
        if (sProj && r.project !== sProj) match = false;
        if (sAct && r.activity !== sAct) match = false;
        if (sSub && r.subActivity !== sSub) match = false;
        return match;
    });

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ
    renderLoanTable(filteredRows);
  }

  // ==========================================
  // 7. SUMMARY REPORT
  // ==========================================
  function loadSummary() {
      var q = $('#sumQuarter').val(); var m = $('#sumMonth').val();
      $('#s-total-alloc').html('<i class="fas fa-spinner fa-spin"></i>');
      google.script.run.withSuccessHandler(renderSummaryPage).getSummaryData(q, m);
  }

  function renderSummaryPage(data) {
      if(data.error) { Swal.fire('Error', data.error, 'error'); return; }
      var fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2});
      $('#s-total-alloc').text(fmt(data.grandTotal.allocated));
      $('#s-total-spent').text(fmt(data.grandTotal.spent));
      $('#s-total-bal').text(fmt(data.grandTotal.allocated - data.grandTotal.spent));
      var pct = (data.grandTotal.allocated > 0) ? (data.grandTotal.spent / data.grandTotal.allocated * 100) : 0;
      $('#s-total-pct').text(pct.toFixed(2) + '%');
      renderSummaryCharts(data); 
      var tSource = $('#tableSourceBody').empty();
      data.bySource.forEach(s => {
          var bal = s.allocated - s.spent;
          var p = (s.allocated > 0) ? (s.spent / s.allocated * 100) : 0;
          var badgeColor = (p >= 80) ? 'bg-success' : (p >= 50 ? 'bg-warning text-dark' : 'bg-danger');
          tSource.append(`<tr><td class="ps-4 fw-bold">${s.name}</td><td class="text-center">${s.count}</td><td class="text-end text-primary">${fmt(s.allocated)}</td><td class="text-end text-danger">${fmt(s.spent)}</td><td class="text-center"><span class="badge ${badgeColor}">${p.toFixed(2)}%</span></td><td class="text-end pe-4 fw-bold">${fmt(bal)}</td></tr>`);
      });
      var sortProg = (arr) => arr.slice().sort((a, b) => {
          var pA = (a.allocated > 0) ? (a.spent / a.allocated) : 0;
          var pB = (b.allocated > 0) ? (b.spent / b.allocated) : 0;
          return pB - pA; 
      });
      renderDeptTable(sortProg(data.byDeptAll), '#tableDeptAllBody');
      renderDeptTable(sortProg(data.byDeptMoph), '#tableDeptMophBody');
      renderDeptTable(sortProg(data.byDeptNon), '#tableDeptNonBody');
  }

  function renderDeptTable(deptList, tbodyId) {
      var tbody = $(tbodyId).empty();
      if (!deptList || deptList.length === 0) { tbody.append('<tr><td colspan="6" class="text-center py-3 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'); return; }
      var fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2});
      deptList.forEach(d => {
          var bal = d.allocated - d.spent;
          var p = (d.allocated > 0) ? (d.spent / d.allocated * 100) : 0;
          var colorClass = (p >= 80) ? 'bg-success' : (p >= 50 ? 'bg-warning' : 'bg-danger');
          tbody.append(`<tr style="cursor: pointer;" onclick="openDrillDown('${d.name}')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"><td class="ps-4 text-nowrap fw-bold text-primary"><i class="fas fa-search me-2 small opacity-50"></i>${d.name}</td><td class="text-center">${d.count}</td><td class="text-end">${fmt(d.allocated)}</td><td class="text-end">${fmt(d.spent)}</td><td class="align-middle px-3"><div class="progress" style="height: 20px;"><div class="progress-bar ${colorClass}" role="progressbar" style="width: ${p}%">${p.toFixed(1)}%</div></div></td><td class="text-end pe-4 fw-bold ${bal < 0 ? 'text-danger' : 'text-success'}">${fmt(bal)}</td></tr>`);
      });
  }

  function renderSummaryCharts(data) {
      if (summaryPieChart) summaryPieChart.destroy();
      var ctxPie = document.getElementById('chartSource').getContext('2d');
      summaryPieChart = new Chart(ctxPie, {
          type: 'doughnut',
          data: { labels: data.bySource.map(s => s.name), datasets: [{ data: data.bySource.map(s => s.allocated), backgroundColor: ['#0d6efd', '#fd7e14', '#20c997', '#ffc107'], borderWidth: 1 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
      });
      if (summaryBarChart) summaryBarChart.destroy();
      var top5 = data.byDeptAll.slice(0, 5);
      var ctxBar = document.getElementById('chartTopDept').getContext('2d');
      summaryBarChart = new Chart(ctxBar, {
          type: 'bar',
          data: { labels: top5.map(d => d.name), datasets: [{ label: '‡∏á‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£', data: top5.map(d => d.allocated), backgroundColor: '#198754', borderRadius: 4 }, { label: '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢', data: top5.map(d => d.spent), backgroundColor: '#dc3545', borderRadius: 4 }] },
          options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } } }
      });
  }

  // --- DRILL DOWN LOGIC ---
  function openDrillDown(deptName) {
      CURRENT_DD_DATA = null; 
      $('#ddTitle').text(deptName);
      $('#ddAlloc, #ddSpent, #ddProgress').html('<i class="fas fa-spinner fa-spin text-secondary"></i>');
      $('#ddTableBodyAll, #ddTableBodyMoph, #ddTableBodyNon').html('<tr><td colspan="5" class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-success"></i><div class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></td></tr>');
      var triggerEl = document.querySelector('#deptDrillDownModal button[data-bs-target="#tab-dd-all"]');
      if (triggerEl) { var tab = bootstrap.Tab.getInstance(triggerEl); if (tab) tab.show(); else new bootstrap.Tab(triggerEl).show(); }
      new bootstrap.Modal(document.getElementById('deptDrillDownModal')).show();
      var q = $('#sumQuarter').val();
      var m = $('#sumMonth').val();
      google.script.run.withSuccessHandler(renderDrillDownData).getDeptDetails(deptName, q, m);
  }

  function renderDrillDownData(data) {
      if(data.error) { $('#ddTableBodyAll').html(`<tr><td colspan="5" class="text-center text-danger">${data.error}</td></tr>`); return; }
      CURRENT_DD_DATA = data;
      renderProjectTable(data.projectsAll, '#ddTableBodyAll');
      renderProjectTable(data.projectsMoph, '#ddTableBodyMoph');
      renderProjectTable(data.projectsNon, '#ddTableBodyNon');
      updateDrillDownCards('all');
      $('button[data-bs-toggle="tab"]').off('shown.bs.tab').on('shown.bs.tab', function (e) {
          var t = $(e.target).attr("data-bs-target"); 
          if (t === '#tab-dd-all') updateDrillDownCards('all');
          if (t === '#tab-dd-moph') updateDrillDownCards('moph');
          if (t === '#tab-dd-non') updateDrillDownCards('non');
      });
  }

  function renderProjectTable(projectList, tbodyId) {
      var tbody = $(tbodyId).empty();
      if (!projectList || projectList.length === 0) { tbody.append('<tr><td colspan="5" class="text-center py-3 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'); return; }
      var fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2});
      projectList.forEach(p => {
          var pct = p.progress || 0;
          var colorClass = (pct >= 80) ? 'bg-success' : (pct >= 50 ? 'bg-warning text-dark' : 'bg-danger');
          var balColor = (p.balance < 0) ? 'text-danger' : 'text-success';
          tbody.append(`<tr><td class="ps-3"><div class="fw-bold text-dark text-wrap" style="font-size: 0.95rem;">${p.project}</div><div class="small text-muted mt-1"><i class="fas fa-tasks me-1 opacity-50"></i>${p.activity}</div></td><td class="text-end fw-bold text-secondary">${fmt(p.allocated)}</td><td class="text-end fw-bold text-danger">${fmt(p.spent)}</td><td class="align-middle px-2"><div class="progress" style="height: 18px; background-color: #e9ecef;"><div class="progress-bar ${colorClass}" role="progressbar" style="width: ${pct}%">${pct.toFixed(1)}%</div></div></td><td class="text-end pe-3 fw-bold ${balColor}">${fmt(p.balance)}</td></tr>`);
      });
  }

  function updateDrillDownCards(type) {
      if (!CURRENT_DD_DATA) return;
      var s = (type === 'moph') ? CURRENT_DD_DATA.sumMoph : (type === 'non' ? CURRENT_DD_DATA.sumNon : CURRENT_DD_DATA.sumAll);
      var fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2});
      $('#ddAlloc, #ddSpent, #ddProgress').hide().fadeIn(200);
      $('#ddAlloc').text(fmt(s.allocated)); $('#ddSpent').text(fmt(s.spent));
      var pct = (s.allocated > 0) ? (s.spent / s.allocated * 100) : 0;
      $('#ddProgress').text(pct.toFixed(2) + '%');
  }

  function openRepaymentModal(timestamp, project, loanAmt, balance) { $('#rpTimestamp').val(timestamp); $('#rpProject').text(project); $('#rpLoanAmount').text(Number(loanAmt).toLocaleString()); $('#rpBalance').text(Number(balance).toLocaleString()); $('#rpAmount').val(''); document.getElementById('rpDate').valueAsDate = new Date(); var modal = new bootstrap.Modal(document.getElementById('repaymentModal')); modal.show(); }
  
  // üìå [‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå js.html ‡∏Ñ‡∏£‡∏±‡∏ö
  function submitRepayment() { 
      var timestamp = $('#rpTimestamp').val(); 
      var amount = parseFloat($('#rpAmount').val()); 
      var date = $('#rpDate').val(); 
      
      if (!amount || amount <= 0) { 
          Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏à‡πà‡∏≤‡∏¢', 'warning'); 
          return; 
      } 
      
      var $btn = $('#repaymentModal .modal-footer .btn-success');
      var originalText = $btn.html();
      $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');

      google.script.run
          .withSuccessHandler(function(res) { 
              $btn.prop('disabled', false).html(originalText);
              
              if (res.status === 'success') { 
                  Swal.fire({
                      icon: 'success',
                      title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                      text: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                      timer: 1500,
                      showConfirmButton: false
                  });
                  $('#repaymentModal').modal('hide'); 
                  
                  // ‚úÖ‚úÖ [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö ‚úÖ‚úÖ
                  refreshLoanTableData(); 
                  
              } else {
                  Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.message, 'error');
              }
          })
          .withFailureHandler(function(error) {
              $btn.prop('disabled', false).html(originalText);
              Swal.fire('Server Error', error.message, 'error');
          })
          .updateLoanRepayment({ timestamp: timestamp, paidAmount: amount, payDate: date }); 
  }

  function onCascadingChange(prefix, level) {
      var order = $('#'+prefix+'Order').val();
      var projSel = $('#'+prefix+'Proj');
      var actSel = $('#'+prefix+'Act');
      var subSel = $('#'+prefix+'Sub');
      var divSub = $('#wrapper_'+prefix+'_sub');
      if (level === 'order') {
          projSel.empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ --</option>').prop('disabled', true);
          actSel.empty().append('<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>').prop('disabled', true);
          subSel.empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢ --</option>').prop('disabled', true);
          divSub.addClass('d-none');
          if (!order) return;
          var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order));
          var projects = [...new Set(rows.map(r => r.project))].sort();
          projects.forEach(p => projSel.append(new Option(p, p)));
          projSel.prop('disabled', false);
      } else if (level === 'proj') {
          var proj = projSel.val();
          actSel.empty().append('<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>').prop('disabled', true);
          subSel.empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢ --</option>').prop('disabled', true);
          divSub.addClass('d-none');
          if (!proj) return;
          var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order) && r.project === proj);
          var activities = [...new Set(rows.map(r => r.activity))].sort();
          activities.forEach(a => actSel.append(new Option(a, a)));
          actSel.prop('disabled', false);
      } else if (level === 'act') {
          var proj = projSel.val(); var act = actSel.val();
          subSel.empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢ --</option>').prop('disabled', true);
          if(!act) { divSub.addClass('d-none'); return; }
          var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order) && r.project === proj && r.activity === act);
          var subActivities = [...new Set(rows.map(r => r.subActivity).filter(s => s && String(s).trim() !== ""))].sort();
          if (subActivities.length > 0) { divSub.removeClass('d-none'); subActivities.forEach(s => subSel.append(new Option(s, s))); subSel.prop('disabled', false); } else { divSub.addClass('d-none'); }
      }
  }
  
  function getTimelineDisplayHtml(timeline) { var months = ['‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.', '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.']; var activeCount = timeline.filter(x => x).length; if (activeCount === 0) return '-'; if (activeCount === 12) return '<span class="badge bg-success rounded-pill fw-normal">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>'; var html = '<div class="d-flex flex-wrap gap-1 justify-content-center flex-column align-items-start">'; var quarters = [ { name: '‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ 1', indices: [0, 1, 2] }, { name: '‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ 2', indices: [3, 4, 5] }, { name: '‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ 3', indices: [6, 7, 8] }, { name: '‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™ 4', indices: [9, 10, 11] } ]; quarters.forEach(function(q) { var activeInQ = q.indices.filter(idx => timeline[idx]); if (activeInQ.length === 3) { html += `<span class="badge bg-primary rounded-pill fw-normal mb-1">${q.name}</span>`; } else if (activeInQ.length > 0) { var monthBadges = activeInQ.map(idx => `<span class="badge bg-success fw-normal">${months[idx]}</span>`).join(' '); html += `<div class="mb-1"><strong class="text-secondary small me-1">${q.name} :</strong>${monthBadges}</div>`; } }); html += '</div>'; return html; }
  function runSearch() { var dept = $('#searchDeptSelect').val(); var type = $('#searchType').val(); var quarter = $('#searchQuarter').val(); var month = $('#searchMonth').val(); if ($.fn.DataTable.isDataTable('#searchTable')) { $('#searchTable').DataTable().destroy(); } $('#searchTableBody').html('<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i></td></tr>'); google.script.run.withSuccessHandler(renderSearchPage).searchActionPlan(dept, type, quarter, month); }
  function resetSearch() { $('#searchDeptSelect').val('').trigger('change'); $('#searchType').val(''); $('#searchQuarter').val(''); $('#searchMonth').val(''); $('#sum-count').text('0'); $('#sum-approved').text('0.00'); $('#sum-allocated').text('0.00'); if ($.fn.DataTable.isDataTable('#searchTable')) { $('#searchTable').DataTable().clear().destroy(); } $('#searchTableBody').empty(); }
  function renderSearchPage(data) { if(data.error) { $('#searchTableBody').html('<tr><td colspan="7" class="text-danger">'+data.error+'</td></tr>'); return; } var fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2}); $('#sum-count').text(Number(data.summary.count).toLocaleString()); $('#sum-approved').text(fmt(data.summary.approved)); $('#sum-allocated').text(fmt(data.summary.allocated)); if ($.fn.DataTable.isDataTable('#searchTable')) { $('#searchTable').DataTable().destroy(); } var tbody = $('#searchTableBody'); tbody.empty(); data.list.forEach(function(row) { var timelineHtml = getTimelineDisplayHtml(row.timeline); tbody.append(`<tr><td class="ps-3">${row.order}</td><td><span class="badge bg-light text-dark border">${row.dept}</span></td><td><div class="fw-bold text-wrap">${row.project}</div><div class="small text-muted">${row.activity}</div></td><td><span class="badge bg-white text-dark border border-secondary text-wrap" style="line-height: 1.4;">${row.budgetType} / ${row.budgetSource}</span></td><td class="text-center text-nowrap">${timelineHtml}</td><td class="text-end text-primary">${fmt(row.approved)}</td><td class="text-end fw-bold text-success">${fmt(row.allocated)}</td></tr>`); }); $('#searchTable').DataTable({ "language": { "search": "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", "paginate": { "next": ">", "previous": "<" } }, "pageLength": 10, "order": [[ 0, "asc" ]] }); }
  function loadYearlyData() { var dept = $('#yearlyDeptSelect').val(); var type = $('#yearlyType').val(); var quarter = $('#yearlyQuarter').val(); var month = $('#yearlyMonth').val(); if ($.fn.DataTable.isDataTable('#yearlyTable')) { $('#yearlyTable').DataTable().destroy(); } $('#yearlyTableBody').html('<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i></td></tr>'); google.script.run.withSuccessHandler(renderYearlyPage).getYearlyPlanData(dept, type, quarter, month); }
  function resetYearly() { $('#yearlyDeptSelect').val('').trigger('change'); $('#yearlyType').val(''); $('#yearlyQuarter').val(''); $('#yearlyMonth').val(''); $('#yp-count').text('0'); $('#yp-approved').text('0.00'); $('#yp-allocated').text('0.00'); if ($.fn.DataTable.isDataTable('#yearlyTable')) { $('#yearlyTable').DataTable().clear().destroy(); } $('#yearlyTableBody').empty(); }
  function renderYearlyPage(data) { if(data.error) { $('#yearlyTableBody').html('<tr><td colspan="8" class="text-danger">'+data.error+'</td></tr>'); return; } var fmt = (n) => Number(n).toLocaleString(undefined, {minimumFractionDigits: 2}); $('#yp-count').text(Number(data.summary.projects).toLocaleString()); $('#yp-approved').text(fmt(data.summary.approved)); $('#yp-allocated').text(fmt(data.summary.allocated)); if ($.fn.DataTable.isDataTable('#yearlyTable')) { $('#yearlyTable').DataTable().destroy(); } var tbody = $('#yearlyTableBody'); tbody.empty(); data.list.forEach(row => { var timelineHtml = getTimelineDisplayHtml(row.timeline); tbody.append(`<tr><td class="ps-3">${row.order}</td><td><span class="badge bg-light text-dark border">${row.dept}</span></td><td><div class="fw-bold text-wrap" style="font-size: 1rem;">${row.project}</div><div class="small text-muted mt-1"><i class="fas fa-tasks me-1"></i>${row.activity}</div></td><td><span class="badge bg-white text-dark border border-secondary text-wrap" style="line-height: 1.4;">${row.type} / ${row.budgetSource}</span></td><td class="text-center text-nowrap">${timelineHtml}</td><td class="text-end">${fmt(row.allocated)}</td><td class="text-end">${fmt(row.spent)}</td><td class="text-end pe-3 fw-bold ${row.balance < 0 ? 'text-danger':'text-success'}">${fmt(row.balance)}</td></tr>`); }); $('#yearlyTable').DataTable({ "language": { "search": "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", "paginate": { "next": ">", "previous": "<" } }, "pageLength": 10, "order": [[ 0, "asc" ]] }); }
  function initYearlyPage() { }

  // function ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
    // ==========================================
    // 8. BUDGET ALLOCATION SYSTEM (FIXED CASCADING & PLAN)
    // ==========================================

    var ALLOC_HISTORY_CACHE = [];
    var SELECTED_ALLOC_ROW = null;

    // --- INITIALIZATION ---
    function initAllocPage() {
        loadAllocHistory();
        populateAllocDropdowns();
    }

    $(document).ready(function() {
        // 1. Setup Select2 for Search
        ['#sAllocOrder', '#sAllocProj', '#sAllocAct', '#sAllocSub'].forEach(id => {
            $(id).select2({ theme: 'bootstrap-5', placeholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowClear: true, width: '100%' });
        });

        // 2. Setup Select2 for Form (‡πÄ‡∏û‡∏¥‡πà‡∏° #fAllocCat)
        var formSelects = ['#fAllocOrder', '#fAllocProj', '#fAllocAct', '#fAllocSub'];
        formSelects.forEach(id => {
            $(id).select2({ 
                theme: 'bootstrap-5', placeholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowClear: true, width: '100%', dropdownParent: $('#allocModal'),
                templateResult: formatState, templateSelection: formatState
            });
        });

        // 3. Bind Events (Search) - ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô
        $('#sAllocOrder').on('change', function() { cascadeAllocSearch('order'); });
        $('#sAllocProj').on('change', function() { cascadeAllocSearch('proj'); });
        $('#sAllocAct').on('change', function() { cascadeAllocSearch('act'); });

        // 4. Bind Events (Form)
        $('#fAllocOrder').on('change', function() { cascadeAllocForm('order'); });
        // $('#fAllocDept').on('change', function() { cascadeAllocForm('dept'); });
        // $('#fAllocCat').on('change', function() { cascadeAllocForm('cat'); }); // ‡πÄ‡∏û‡∏¥‡πà‡∏° event
        $('#fAllocPlan').on('change', function() { cascadeAllocForm('plan'); });
        $('#fAllocProj').on('change', function() { cascadeAllocForm('proj'); });
        $('#fAllocAct').on('change', function() { cascadeAllocForm('act'); });
        $('#fAllocSub').on('change', function() { showAllocInfoBox(); });
    });

    function populateAllocDropdowns() {
        if(!CACHED_OPTIONS) return;
        var orders = [...new Set(CACHED_OPTIONS.map(r => r.order).filter(o=>o))].sort((a,b)=>a-b);
        
        // ‡πÄ‡∏ï‡∏¥‡∏° Dropdown ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å (‡∏•‡∏≥‡∏î‡∏±‡∏ö)
        var $s = $('#sAllocOrder').empty().append('<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>');
        var $f = $('#fAllocOrder').empty().append('<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö --</option>');
        orders.forEach(o => {
            $s.append(new Option(o, o));
            $f.append(new Option(o, o));
        });
    }

    // --- LOGIC SEARCH CASCADE (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö) ---
    function cascadeAllocSearch(level) {
        var order = $('#sAllocOrder').val();
        var proj = $('#sAllocProj').val();
        var act = $('#sAllocAct').val();

        var reset = (ids) => ids.forEach(id => $(id).empty().append('<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>').prop('disabled', true));

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö
        var rows = CACHED_OPTIONS;
        if(order) rows = rows.filter(r => String(r.order) === String(order));

        if (level === 'order') {
            reset(['#sAllocProj', '#sAllocAct', '#sAllocSub']);
            if (order) {
                var projs = [...new Set(rows.map(r => r.project))].sort();
                projs.forEach(p => $('#sAllocProj').append(new Option(p, p)));
                $('#sAllocProj').prop('disabled', false);
            }
        } else if (level === 'proj') {
            reset(['#sAllocAct', '#sAllocSub']);
            if (proj) {
                var subRows = rows.filter(r => r.project === proj);
                var acts = [...new Set(subRows.map(r => r.activity))].sort();
                acts.forEach(a => $('#sAllocAct').append(new Option(a, a)));
                $('#sAllocAct').prop('disabled', false);
            }
        } else if (level === 'act') {
            reset(['#sAllocSub']);
            if (act) {
                var subRows = rows.filter(r => r.project === proj && r.activity === act);
                var subs = [...new Set(subRows.map(r => r.subActivity).filter(s => s))].sort();
                if (subs.length > 0) {
                    subs.forEach(s => $('#sAllocSub').append(new Option(s, s)));
                    $('#sAllocSub').prop('disabled', false);
                }
            }
        }
    }

    // ---‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LOGIC FORM CASCADE ---
    function cascadeAllocForm(level) {
        var order = $('#fAllocOrder').val();
        var proj = $('#fAllocProj').val();
        var act = $('#fAllocAct').val();

        var reset = (ids) => ids.forEach(id => $(id).empty().append('<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>').prop('disabled', true));

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        var rows = CACHED_OPTIONS.filter(r => String(r.order) === String(order));
        
        // Level 1: Order -> Project (‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏¢‡∏¥‡∏á‡∏ï‡∏£‡∏á‡πÑ‡∏õ Project)
        if(level === 'order') {
            reset(['#fAllocProj', '#fAllocAct', '#fAllocSub']);
            if(!order) return;
            
            // ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ
            var projs = [...new Set(rows.map(r => r.project))].sort();
            projs.forEach(p => $('#fAllocProj').append(new Option(p, p)));
            $('#fAllocProj').prop('disabled', false);
        }

        // Level 2: Project -> Activity
        if(level === 'proj') {
            reset(['#fAllocAct', '#fAllocSub']);
            if(!proj) return;
            
            rows = rows.filter(r => r.project === proj);
            var acts = [...new Set(rows.map(r => r.activity))].sort();
            acts.forEach(a => $('#fAllocAct').append(new Option(a, a)));
            $('#fAllocAct').prop('disabled', false);
        }

        // Level 3: Activity -> SubActivity
        if(level === 'act') {
            reset(['#fAllocSub']);
            if(!act) return;
            
            rows = rows.filter(r => r.project === proj && r.activity === act);
            var subs = [...new Set(rows.map(r => r.subActivity).filter(s => s))].sort();
            if(subs.length > 0) {
                subs.forEach(s => $('#fAllocSub').append(new Option(s, s)));
                $('#fAllocSub').prop('disabled', false);
            } else {
                showAllocInfoBox();
            }
        }
    }
    // --‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î LOGIC FORM CASCADE ---

    // --- OTHER FUNCTIONS (InfoBox & Submit) ---
    // (‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏Å‡πä‡∏≠‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå)
    // üìå [‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showAllocInfoBox ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå js.html
      function showAllocInfoBox() {
          var order = $('#fAllocOrder').val();
          var proj = $('#fAllocProj').val();
          var act = $('#fAllocAct').val();
          var sub = $('#fAllocSub').val();

          var row = CACHED_OPTIONS.find(r => 
              String(r.order) === String(order) && 
              r.project === proj && 
              r.activity === act && 
              (sub ? r.subActivity === sub : true)
          );

          if (row) {
              SELECTED_ALLOC_ROW = row;
              $('#allocInfoBox').removeClass('d-none');
              
              $('#info_cat').text(row.category || '-');
              $('#info_source').text((row.budgetType || '-') + ' / ' + (row.budgetSource || '-'));
              
              // ‚úÖ [‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ > ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
              var sep = '<span class="text-primary fw-bold mx-2" style="font-size:1.1em;">></span>';
              
              var fullname = `<span class="text-dark">${row.project}</span>` + 
                            sep + `<span class="text-muted">${row.activity}</span>`;
                            
              if(row.subActivity) {
                  fullname += sep + `<span class="text-muted fst-italic">${row.subActivity}</span>`;
              }
              
              // ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ .html() ‡πÅ‡∏ó‡∏ô .text() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÑ‡∏î‡πâ
              $('#info_fullname').html(fullname); 

              // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
              $('#info_approve').text(Number(row.approved || 0).toLocaleString());
              $('#info_allocated').text(Number(row.allocated).toLocaleString());
              $('#info_spent').text(Number(row.spent).toLocaleString());
          } else {
              $('#allocInfoBox').addClass('d-none');
              SELECTED_ALLOC_ROW = null;
          }
      }
  //‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î function ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì

// ==========================================
// üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ: Modal, Save, History Table
// ==========================================

// 1. ‡πÄ‡∏õ‡∏¥‡∏î Modal (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î)
function openAllocModal() {
    // Reset Form
    $('#fAllocOrder').val(null).trigger('change');
    $('#fAllocAmount').val('');
    $('#fAllocLetter').val('');
    $('#fAllocRemark').val('');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    var today = new Date();
    var yyyy = today.getFullYear();
    var mm = String(today.getMonth() + 1).padStart(2, '0');
    var dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('fAllocDate').value = yyyy + '-' + mm + '-' + dd;

    $('#allocInfoBox').addClass('d-none');
    
    new bootstrap.Modal(document.getElementById('allocModal')).show();
}

// 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Submit)
function submitNewAllocation() {
    // Validate Input
    if (!SELECTED_ALLOC_ROW) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning'); return; }
    var amount = parseFloat($('#fAllocAmount').val());
    var date = $('#fAllocDate').val();
    
    if (!amount || isNaN(amount)) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£', 'warning'); return; }
    if (!date) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£', 'warning'); return; }

    // Prepare Data
    var formData = {
        id: SELECTED_ALLOC_ROW.id, 
        currentAlloc: amount,      
        date: date,                
        letterNo: $('#fAllocLetter').val(), 
        remark: $('#fAllocRemark').val(),   
        fullData: SELECTED_ALLOC_ROW 
    };

    // UI Loading
    var $btn = $('#allocModal .modal-footer .btn-warning');
    var orgHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');

    // Call Server
    google.script.run.withSuccessHandler(function(res) {
        $btn.prop('disabled', false).html(orgHtml);
        if (res.status === 'success') {
            Swal.fire({
                icon: 'success',
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                timer: 1500,
                showConfirmButton: false
            });
            $('#allocModal').modal('hide');
            
            refreshMasterData(); // ‡πÇ‡∏´‡∏•‡∏î Master ‡πÉ‡∏´‡∏°‡πà
            loadAllocHistory();  // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà
        } else {
            Swal.fire('Error', res.message, 'error');
        }
    }).saveAllocation(formData);
}

// 3. ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Dropdown ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Error ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
function loadAllocHistory() {
    $('#allocHistoryBody').html('<tr><td colspan="7" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</td></tr>');
    google.script.run.withSuccessHandler(function(data) {
        ALLOC_HISTORY_CACHE = data || [];
        renderAllocHistoryTable(ALLOC_HISTORY_CACHE);
    }).getAllocationHistory();
}

// 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
function renderAllocHistoryTable(rows) {
    var tbody = $('#allocHistoryBody').empty();
    
    if (!rows || rows.length === 0) {
        tbody.append('<tr><td colspan="7" class="text-center py-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£</td></tr>');
        return;
    }
    
    rows.forEach(r => {
        var dateShow = r.date; 
        var desc = `<div class="fw-bold text-dark text-wrap" style="font-size: 0.95rem;">${r.project}</div>`;
        if(r.activity) desc += `<div class="small text-muted mt-1"><i class="fas fa-angle-right me-1"></i>${r.activity}</div>`;
        if(r.subActivity) desc += `<div class="small text-muted ms-3 fst-italic">- ${r.subActivity}</div>`;

        // Badge ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏á‡∏ö
        var sourceHtml = `<div class="d-flex flex-column gap-1">
            <span class="badge bg-light text-dark border fw-normal">${r.type || '-'}</span>
            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 fw-normal text-wrap">${r.source || '-'}</span>
        </div>`;

        tbody.append(`
            <tr>
                <td class="text-center text-primary fw-bold small text-nowrap">${dateShow}</td>
                <td class="text-center fw-bold text-secondary">${r.order}</td>
                <td>${desc}</td>
                <td>${sourceHtml}</td>
                <td class="text-center small">${r.letterNo || '-'}</td>
                <td class="text-end fw-bold text-primary">+${Number(r.currentAlloc).toLocaleString()}</td>
                <td class="text-end fw-bold text-success">${Number(r.accumulatedAlloc).toLocaleString()}</td>
            </tr>
        `);
    });
}

// 5. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
function runAllocHistorySearch() {
    var order = $('#sAllocOrder').val();
    var proj = $('#sAllocProj').val();
    
    // Filter ‡∏à‡∏≤‡∏Å CACHE
    var filtered = ALLOC_HISTORY_CACHE.filter(r => {
        var match = true;
        if(order && String(r.order) !== String(order)) match = false;
        if(proj && r.project !== proj) match = false;
        return match;
    });
    renderAllocHistoryTable(filtered);
}

// 6. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
function resetAllocSearch() {
    $('#sAllocOrder').val(null).trigger('change');
    renderAllocHistoryTable(ALLOC_HISTORY_CACHE);
}

</script>
